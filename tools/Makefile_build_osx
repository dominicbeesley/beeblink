# -*- mode:makefile-gmake; -*-

# ifeq ($(RELEASE_NAME),)
# $(error RELEASE_NAME not set)
# endif

SUFFIX?=$(shell git log -1 --format=%cd-%h --date=format:%Y%m%d-%H%M%S)

DEST:=./.build
TMP:=$(DEST)/$(RELEASE_NAME)

.PHONY:default
default:
	$(error specify target)

##########################################################################
##########################################################################

.PHONY:travis_osx
build_travis_osx:
	test -n "$(RELEASE_NAME)" # if this line fails, RELEASE_NAME is not set
	cd ./firmware && make beeblink.hex
	cd ./rom && make
	cd ./server && npm install
	cd ./server && npm run compile
	-cd ./server && npm run lint
	cd ./server && ./node_modules/.bin/pkg -t node8-macos-x64 .

	mkdir -p $(TMP)
	cp ./firmware/beeblink.hex $(TMP)/beeblink-minimus_avr_usb_32k.hex
	cp ./rom/.build/beeblink.rom $(TMP)/
	cp ./server/beeblink-server $(TMP)/
	cp -R ./volumes $(TMP)/
	cd $(DEST) && 7z a $(RELEASE_NAME).zip $(RELEASE_NAME)

##########################################################################
##########################################################################

.PHONY:clean_travis_osx
clean_travis_osx:
	cd ./firmware && make clean
	cd ./rom && make clean
	cd ./server && rm -Rf node_modules
	-cd ./server && rm beeblink-server

##########################################################################
##########################################################################
